ok
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopstepX Trading Bot Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0e16; color: #e0e6ed; }
    .container { display: flex; height: 100vh; }
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    .sidebar { width: 300px; background: #161b22; padding: 20px; overflow-y: auto; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
    .logo { font-size: 24px; font-weight: bold; color: #4CAF50; }
    .status-indicator { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; }
    .status-dot.online { background: #4CAF50; animation: pulse 2s infinite; }
    .status-dot.offline { background: #f44336; }
    .status-dot.connecting { background: #ffa657; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .tabs { display: flex; border-bottom: 2px solid #30363d; margin-bottom: 20px; }
    .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; color: #8b949e; font-size: 14px; }
    .tab.active { color: #4CAF50; border-bottom: 2px solid #4CAF50; }
    .tab:hover { color: #f0f6fc; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 20px; }
    .card-header { padding: 16px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 600; font-size: 16px; }
    .card-body { padding: 16px; }
    
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .metric-card { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 16px; text-align: center; }
    .metric-value { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
    .metric-label { font-size: 14px; color: #8b949e; }
    .metric-value.good { color: #4CAF50; }
    .metric-value.bad { color: #f85149; }
    .metric-value.neutral { color: #ffa657; }
    
    .learning-status { display: flex; align-items: center; gap: 10px; margin: 16px 0; }
    .learning-dot { width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; animation: pulse 1.5s infinite; }
    
    .log-container { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; height: 400px; overflow-y: auto; }
    .log-controls { padding: 12px; border-bottom: 1px solid #21262d; display: flex; gap: 8px; }
    .log-filter { padding: 6px 12px; border: 1px solid #30363d; background: #161b22; color: #e0e6ed; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .log-filter.active { background: #4CAF50; color: white; }
    .log-stream { padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; }
    .log-entry { margin-bottom: 4px; }
    .log-entry.info { color: #58a6ff; }
    .log-entry.warning { color: #d29922; }
    .log-entry.error { color: #f85149; }
    .log-entry.success { color: #3fb950; }
    .log-entry.learning { color: #a5b4fc; }
    
    .actions { display: flex; gap: 12px; margin-bottom: 20px; }
    .btn { padding: 8px 16px; border: 1px solid #30363d; background: #21262d; color: #e0e6ed; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn:hover { background: #30363d; }
    .btn.primary { background: #238636; border-color: #238636; }
    .btn.primary:hover { background: #2ea043; }
    .btn.danger { background: #da3633; border-color: #da3633; }
    .btn.danger:hover { background: #f85149; }
    
    .connection-status { padding: 12px; border-radius: 6px; margin-bottom: 16px; }
    .connection-status.connected { background: rgba(63, 185, 80, 0.1); border: 1px solid #3fb950; }
    .connection-status.disconnected { background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; }
    .connection-status.connecting { background: rgba(255, 166, 87, 0.1); border: 1px solid #ffa657; }
    
    .progress-bar { width: 100%; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s ease; }
    
    .refresh-timer { font-size: 12px; color: #8b949e; margin-left: auto; }
    
    .trade-entry, .position-entry { 
      padding: 8px; margin-bottom: 8px; background: #0d1117; border-radius: 4px; 
      display: flex; justify-content: space-between; align-items: center; 
    }
    .trade-side.buy, .position-side.long { color: #4CAF50; }
    .trade-side.sell, .position-side.short { color: #f85149; }
    .empty-state { text-align: center; color: #8b949e; padding: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="header">
        <div class="logo">TopstepX Trading Bot</div>
        <div class="status-indicator">
          <div class="status-dot connecting" id="connectionStatus"></div>
          <span id="connectionText">Connecting...</span>
        </div>
      </div>

      <div class="connection-status connecting" id="connectionBanner">
        <strong>Connecting to bot...</strong> - Establishing real-time connection
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('trading')">Trading</button>
        <button class="tab" onclick="showTab('learning')">AI Learning</button>
        <button class="tab" onclick="showTab('logs')">Logs</button>
      </div>

      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value neutral" id="accountBalance">--</div>
            <div class="metric-label">Account Balance</div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral" id="totalPnL">--</div>
            <div class="metric-label">Total P&L</div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral" id="openPositions">--</div>
            <div class="metric-label">Open Positions</div>
          </div>
          <div class="metric-card">
            <div class="metric-value neutral" id="todayTrades">--</div>
            <div class="metric-label">Today's Trades</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">System Status</div>
            <span class="refresh-timer" id="overviewTimer">--</span>
          </div>
          <div class="card-body">
            <div class="learning-status">
              <div class="learning-dot" id="learningIndicator"></div>
              <span id="learningStatus">AI Learning System: Initializing...</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="learningProgressBar" style="width: 0%"></div>
            </div>
            <div id="systemMetrics">
              <p><strong>Bot Mode:</strong> <span id="botMode">--</span></p>
              <p><strong>Strategy:</strong> <span id="activeStrategy">--</span></p>
              <p><strong>Last Update:</strong> <span id="lastUpdate">--</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Trading Tab -->
      <div id="trading" class="tab-content">
        <div class="actions">
          <button class="btn primary" onclick="executeAction('start-trading')">Start Trading</button>
          <button class="btn" onclick="executeAction('pause-trading')">Pause Trading</button>
          <button class="btn danger" onclick="executeAction('stop-trading')">Stop Trading</button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Trades</div>
            <span class="refresh-timer" id="tradingTimer">--</span>
          </div>
          <div class="card-body">
            <div id="recentTrades">
              <div class="empty-state">Loading recent trades...</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current Positions</div>
          </div>
          <div class="card-body">
            <div id="currentPositions">
              <div class="empty-state">Loading positions...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Learning Tab -->
      <div id="learning" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Learning Progress</div>
            <span class="refresh-timer" id="learningTimer">--</span>
          </div>
          <div class="card-body">
            <div id="learningProgress">
              <p><strong>Current Loop:</strong> <span id="currentLoop">--</span></p>
              <p><strong>Learning Rate:</strong> <span id="learningRate">--</span></p>
              <p><strong>Adaptation Cycle:</strong> <span id="adaptationCycle">Every 2 minutes</span></p>
              <p><strong>Last Adaptation:</strong> <span id="lastAdaptation">--</span></p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Learning Metrics</div>
          </div>
          <div class="card-body">
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value neutral" id="learningAccuracy">--</div>
                <div class="metric-label">Accuracy</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="adaptationScore">--</div>
                <div class="metric-label">Adaptation Score</div>
              </div>
              <div class="metric-card">
                <div class="metric-value neutral" id="modelConfidence">--</div>
                <div class="metric-label">Model Confidence</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Real-time Logs</div>
            <span class="refresh-timer" id="logsTimer">--</span>
          </div>
          <div class="card-body">
            <div class="log-container">
              <div class="log-controls">
                <button class="log-filter active" onclick="filterLogs('all')">All</button>
                <button class="log-filter" onclick="filterLogs('info')">Info</button>
                <button class="log-filter" onclick="filterLogs('warning')">Warning</button>
                <button class="log-filter" onclick="filterLogs('error')">Error</button>
                <button class="log-filter" onclick="filterLogs('success')">Success</button>
                <button class="log-filter" onclick="filterLogs('learning')">Learning</button>
                <button class="btn" onclick="clearLogs()" style="margin-left: auto; font-size: 11px; padding: 4px 8px;">Clear</button>
              </div>
              <div class="log-stream" id="logStream">
                <div class="log-entry info">Connecting to bot log stream...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ðŸ§  AI Learning System</div>
        </div>
        <div class="card-body">
          <div class="learning-status">
            <div class="learning-dot"></div>
            <span id="learningStatusSidebar">Learning active...</span>
          </div>
          <div class="metrics-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="metric-card">
              <div class="metric-value" id="learningCycles">0</div>
              <div class="metric-label">Cycles</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="learningAccuracySidebar">0%</div>
              <div class="metric-label">Accuracy</div>
            </div>
          </div>
          <button class="btn primary" style="width: 100%; margin-top: 16px;" onclick="triggerLearning()">Run Learning Cycle</button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">System Status</div>
        </div>
        <div class="card-body">
          <div class="metric-card">
            <div class="metric-value" id="uptime">--</div>
            <div class="metric-label">Uptime</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="dataQuality">--</div>
            <div class="metric-label">Data Quality</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let eventSource = null;
    let connectionAttempts = 0;
    let maxRetries = 10;
    let logFilter = 'all';
    let lastUpdateTime = null;
    let isConnected = false;
    let reconnectTimer = null; // Add timer to prevent rapid reconnections

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
      addLog('info', 'Dashboard initialized, connecting to bot...');
      connectToBot();
      
      // Update timers every 5 seconds
      setInterval(updateTimers, 5000);
    });

    // Enhanced connection management with exponential backoff
    function connectToBot() {
      // Clear any existing reconnection timer
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      
      if (eventSource) {
        eventSource.close();
      }

      connectionAttempts++;
      updateConnectionStatus('connecting', 'Connecting...');

      try {
        // Use optimized 5-second intervals to prevent server overload
        // Add required parameters: symbol=ES and res=1 (1-minute bars)
        eventSource = new EventSource('/stream/realtime?symbol=ES&res=1');
        
        eventSource.onopen = function() {
          connectionAttempts = 0;
          isConnected = true;
          updateConnectionStatus('connected', 'Connected');
          addLog('success', 'Connected to real-time stream');
        };

        eventSource.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            handleRealtimeData(data);
            lastUpdateTime = new Date();
          } catch (error) {
            addLog('error', `Failed to parse data: ${error.message}`);
          }
        };

        eventSource.onerror = function() {
          addLog('error', `EventSource error - readyState: ${eventSource.readyState}`);
          isConnected = false;
          updateConnectionStatus('disconnected', 'Connection Lost');
          
          // TEMPORARILY DISABLE AUTO-RECONNECT TO STOP SPAM
          addLog('info', 'Auto-reconnect disabled to prevent spam');
          
          /*
          // Prevent rapid reconnections by using timer
          if (connectionAttempts < maxRetries && !reconnectTimer) {
            // Exponential backoff: 2s, 4s, 8s, 16s, 32s, max 30s
            const delay = Math.min(1000 * Math.pow(2, connectionAttempts), 30000);
            reconnectTimer = setTimeout(() => {
              reconnectTimer = null;
              connectToBot();
            }, delay);
          } else if (connectionAttempts >= maxRetries) {
            addLog('error', 'Max reconnection attempts reached');
          }
          */
        };

      } catch (error) {
        updateConnectionStatus('disconnected', 'Connection Failed');
        addLog('error', `Connection failed: ${error.message}`);
      }
    }

    function updateConnectionStatus(status, text) {
      const statusDot = document.getElementById('connectionStatus');
      const statusText = document.getElementById('connectionText');
      const banner = document.getElementById('connectionBanner');
      
      statusDot.className = `status-dot ${status === 'connected' ? 'online' : status}`;
      statusText.textContent = text;
      
      if (status === 'connected') {
        banner.className = 'connection-status connected';
        banner.innerHTML = '<strong>Connected</strong> - Real-time data streaming';
      } else if (status === 'connecting') {
        banner.className = 'connection-status connecting';
        banner.innerHTML = '<strong>Connecting...</strong> - Establishing connection';
      } else {
        banner.className = 'connection-status disconnected';
        banner.innerHTML = '<strong>Disconnected</strong> - Attempting to reconnect';
      }
    }

    function handleRealtimeData(data) {
      try {
        // Update overview metrics
        if (data.overview) {
          updateElement('accountBalance', formatCurrency(data.overview.accountBalance));
          updateElement('totalPnL', formatCurrency(data.overview.totalPnL, true));
          updateElement('openPositions', data.overview.openPositions || 0);
          updateElement('todayTrades', data.overview.todayTrades || 0);
          updateElement('botMode', data.overview.botMode || 'PAPER');
          updateElement('activeStrategy', data.overview.activeStrategy || 'EMA Cross');
          updateElement('lastUpdate', new Date().toLocaleTimeString());
        }

        // Update learning status
        if (data.learning) {
          updateElement('learningStatus', `AI Learning System: ${data.learning.status || 'Active'}`);
          updateElement('learningStatusSidebar', data.learning.status || 'Learning active...');
          updateElement('currentLoop', data.learning.currentLoop || '--');
          updateElement('learningRate', data.learning.learningRate || '--');
          updateElement('lastAdaptation', data.learning.lastAdaptation || '--');
          updateElement('learningAccuracy', formatPercentage(data.learning.accuracy));
          updateElement('learningAccuracySidebar', formatPercentage(data.learning.accuracy));
          updateElement('adaptationScore', data.learning.adaptationScore || '--');
          updateElement('modelConfidence', formatPercentage(data.learning.modelConfidence));
          updateElement('learningCycles', data.learning.cycles || 0);
          
          if (data.learning.progress !== undefined) {
            const progressBar = document.getElementById('learningProgressBar');
            if (progressBar) progressBar.style.width = `${data.learning.progress}%`;
          }
        }

        // Update trading data
        if (data.trading) {
          updateTradingData(data.trading);
        }

        // Update system metrics
        if (data.system) {
          updateElement('uptime', data.system.uptime || '--');
          updateElement('dataQuality', data.system.dataQuality || '--');
        }

        // Handle log entries
        if (data.logs && Array.isArray(data.logs)) {
          data.logs.forEach(log => addLog(log.level || 'info', log.message || log));
        }

        // Update timers
        updateTimers();

      } catch (error) {
        addLog('error', `Error processing data: ${error.message}`);
      }
    }

    function updateElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
        
        // Add color coding for P&L metrics
        if (id.includes('PnL') && element.classList.contains('metric-value')) {
          const numValue = parseFloat(value.toString().replace(/[^-\d.]/g, ''));
          if (!isNaN(numValue)) {
            element.className = numValue > 0 ? 'metric-value good' : 
                               numValue < 0 ? 'metric-value bad' : 'metric-value neutral';
          }
        }
      }
    }

    function updateTradingData(trading) {
      if (trading.recentTrades) {
        const tradesContainer = document.getElementById('recentTrades');
        if (tradesContainer) {
          tradesContainer.innerHTML = trading.recentTrades.length > 0 ?
            trading.recentTrades.map(trade => 
              `<div class="trade-entry">
                <div>
                  <span class="trade-side ${trade.side.toLowerCase()}">${trade.side}</span> 
                  <span>${trade.symbol}</span> Ã— ${trade.quantity}
                </div>
                <div>
                  <span>${formatCurrency(trade.price)}</span>
                  <small>${formatTime(trade.time)}</small>
                </div>
              </div>`
            ).join('') : '<div class="empty-state">No recent trades</div>';
        }
      }

      if (trading.positions) {
        const positionsContainer = document.getElementById('currentPositions');
        if (positionsContainer) {
          positionsContainer.innerHTML = trading.positions.length > 0 ?
            trading.positions.map(pos => 
              `<div class="position-entry">
                <div>
                  <span class="position-side ${pos.side.toLowerCase()}">${pos.quantity} ${pos.side}</span> 
                  <span>${pos.symbol}</span>
                </div>
                <div>
                  <span>${formatCurrency(pos.avgPrice)}</span>
                  <span class="${pos.pnl >= 0 ? 'good' : 'bad'}">${formatCurrency(pos.pnl, true)}</span>
                </div>
              </div>`
            ).join('') : '<div class="empty-state">No open positions</div>';
        }
      }
    }

    function addLog(level, message) {
      const logStream = document.getElementById('logStream');
      if (!logStream) return;

      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${level}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logEntry.style.display = (logFilter === 'all' || logFilter === level) ? 'block' : 'none';

      logStream.appendChild(logEntry);
      
      // Keep only last 100 log entries
      while (logStream.children.length > 100) {
        logStream.removeChild(logStream.firstChild);
      }
      
      logStream.scrollTop = logStream.scrollHeight;
    }

    function updateTimers() {
      const now = new Date().toLocaleTimeString();
      ['overviewTimer', 'tradingTimer', 'learningTimer', 'logsTimer'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = `Updated: ${now}`;
      });
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    function filterLogs(level) {
      logFilter = level;
      document.querySelectorAll('.log-filter').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.log-entry').forEach(entry => {
        entry.style.display = (level === 'all' || entry.classList.contains(level)) ? 'block' : 'none';
      });
    }

    function clearLogs() {
      const logStream = document.getElementById('logStream');
      if (logStream) {
        logStream.innerHTML = '<div class="log-entry info">Logs cleared</div>';
      }
    }

    function executeAction(action) {
      addLog('info', `Executing action: ${action}`);
      
      fetch('/api/actions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action })
      })
      .then(response => response.json())
      .then(data => {
        addLog('success', `Action completed: ${action}`);
        if (data.message) addLog('info', data.message);
      })
      .catch(error => {
        addLog('error', `Action failed: ${error.message}`);
      });
    }

    function triggerLearning() {
      addLog('learning', 'Triggering learning cycle...');
      fetch('/learner/adapt', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.started) {
            addLog('learning', 'Learning cycle started successfully');
          } else {
            addLog('error', 'Failed to start learning cycle');
          }
        })
        .catch(error => {
          addLog('error', 'Error triggering learning: ' + error.message);
        });
    }

    // Utility functions
    function formatCurrency(value, showSign = false) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = parseFloat(value);
      if (isNaN(num)) return '--';
      const formatted = num.toLocaleString('en-US', { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      return showSign && num > 0 ? '+' + formatted : formatted;
    }
    
    function formatPercentage(value) {
      if (value === null || value === undefined || value === '--') return '--';
      const num = parseFloat(value);
      if (isNaN(num)) return '--';
      return `${(num * 100).toFixed(1)}%`;
    }
    
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString();
    }

    // Handle page visibility to prevent excessive connections
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        addLog('info', 'Page hidden, maintaining connection...');
      } else if (!document.hidden && !isConnected) {
        addLog('info', 'Page visible, reconnecting...');
        connectToBot();
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      if (eventSource) {
        eventSource.close();
      }
    });
  </script>
</body>
</html>
